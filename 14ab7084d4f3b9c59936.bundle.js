!function(){"use strict";let e,t,a=null,r=null,o=null,s=0,n={loading:!0,question:null,needKey:!1,done:!1,decryptFailed:!1,reveal:!1,unsaved:!1,saveerror:!1};async function i(e){n=e(n),self.postMessage(n)}function l(){let t=e.shift();i((a=>({...a,question:t,loading:!1,needKey:!1,done:e.length<1,reveal:!1})))}async function u(e,t,a){let r=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t}/values/${encodeURIComponent(`${a}!A:B`)}`,{headers:{Authorization:`Bearer ${e}`}});400==r.status&&await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t}:batchUpdate`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},method:"POST",body:JSON.stringify({requests:[{addSheet:{properties:{title:a}}}]})});let o=await r.json(),s=new Map;if(null!=o.values)for(let e=0;e<o.values.length;e++){let t=parseInt(o.values[e][0]),a=parseInt(o.values[e][1]);isNaN(t)||isNaN(a)||s.set(e+1,{correct:t,total:a})}return s}async function c(e,t){const a=[];for await(const r of async function*(e,t){let a=await fetch(`quizzes/${e}`),r=await a.blob();const o=new Uint8Array([18,182,224,94,67,153,88,240,68,90,143,209,190,39,25,237]);let s=await r.arrayBuffer(),n=new Uint8Array(s,0,12),l=new Uint8Array(s,12),u=new TextEncoder,c=await self.crypto.subtle.importKey("raw",u.encode(t),"PBKDF2",!1,["deriveBits","deriveKey"]),d=await self.crypto.subtle.deriveKey({name:"PBKDF2",salt:o,iterations:1e5,hash:"SHA-256"},c,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);try{let e=await self.crypto.subtle.decrypt({name:"AES-GCM",iv:n},d,l),t=new TextDecoder("utf8"),a=null;for(let r of t.decode(e).split("\n"))if(r.startsWith("#"))null!=a&&(yield a),a={text:null,answers:[],id:parseInt(r.substr(1)),correct:0,total:0,repeat:0};else if(null!=a&&null==a.text)a.text=r;else if(/^(F|T)\:/.test(r)){if(null==a)throw"no question";let e=!1;r.startsWith("T")&&(e=!0),a.answers.push({text:r.replace(/^(F|T)\:/,""),correct:e})}null!=a&&(yield a)}catch(e){throw i((e=>({...e,needKey:!0,decryptFailed:!0,loading:!1}))),e}}(e,t))a.push(r);return a}let d=new class{constructor(){}timeout(e){return new Promise((t=>{setTimeout((()=>{t()}),e)}))}aborter(){let e={aborted:!1,promise:null},t=new Promise(((t,a)=>{this.abort=()=>{e.aborted=!1,a()}}));return e.promise=t,e}async trigger(e){this.abort&&this.abort();let t=this.aborter();try{await Promise.race([this.timeout(e),t.promise])}catch{throw new Error("aborted")}}},p=0;self.addEventListener("message",(h=>{"load"==h.data.type?async function(n,d,p,h,f){i((e=>({...e,needKey:!1,loading:!0,done:!1,question:null,decryptFailed:!1,reveal:!1,unsaved:!1,saveerror:!1})));let y=!!f;if(f||(f=await async function(e,t,a){let r=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t}/values/${encodeURIComponent("base!A:B")}`,{headers:{Authorization:`Bearer ${e}`}}),o=await r.json();if(!o.values)return null;let s=o.values.find((e=>e[0]==a));return s?s[1]:null}(n,d,p)),!f)return void i((e=>({...e,needKey:!0,loading:!1})));let[m,v]=await Promise.all([u(n,d,p),c(p,f)]);for(let e of v){let t=m.get(e.id);t&&(e.total=t.total,e.correct=t.correct)}y&&await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${d}/values/${encodeURIComponent("base!A1:B1")}:append?valueInputOption=RAW`,{headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},method:"POST",body:JSON.stringify({majorDimension:"ROWS",values:[[p,f]]})}),e=function(e){let t,a,r=e.length;for(;0!==r;)a=Math.floor(Math.random()*r),r-=1,t=e[r],e[r]=e[a],e[a]=t;return e}(v),t=[],e=e.sort(((e,t)=>e.correct!=t.correct?e.correct-t.correct:e.total-t.total)),(h.numberOfQuestions<1||h.numberOfQuestions>e.length)&&(h.numberOfQuestions=e.length),h.repeat<0&&h.repeat,e=e.slice(0,h.numberOfQuestions),s=h.repeat,l(),a=n,r=d,o=p}(h.data.access_token,h.data.spreadsheetId,h.data.quizfile,h.data.quizSettings,h.data.decryptionKey):"save"==h.data.type?async function(l){let u=!n.question.answers.map(((e,t)=>l[t]==e.correct)).some((e=>!e));n.question.correct=u?n.question.correct+1:n.question.correct,n.question.total+=1,n.question.repeat<s&&(n.question.repeat+=1,e.push(n.question)),i((t=>({...t,reveal:!0,unsaved:!0,done:e.length<1}))),t.push({id:n.question.id,correct:n.question.correct,total:n.question.total});try{await d.trigger(Math.max(5e3,3e4-(+new Date-p)))}catch{return}let c=Array.from(t);t=[];let h=[];for(let e of c)c.find((t=>e.id==t.id&&t.total>e.total))||h.push(e);if((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${r}/values:batchUpdate`,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},method:"POST",body:JSON.stringify({valueInputOption:"RAW",data:h.map((e=>({range:`${o}!A${e.id}:B${e.id}`,majorDimension:"ROWS",values:[[e.correct,e.total]]})))})})).ok)i((e=>({...e,unsaved:!1,saveerror:!1})));else{for(let e of h)t.push(e);i((e=>({...e,saverror:!0})))}p=+new Date}(h.data.userAnswers):"next"==h.data.type&&l()}))}();
//# sourceMappingURL=14ab7084d4f3b9c59936.bundle.js.map